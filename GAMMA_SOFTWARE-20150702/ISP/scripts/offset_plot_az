#!/usr/bin/perl
use FileHandle;

$sflag = 1;

if (($#ARGV + 1) < 5){die <<EOS ;}
*** IPTA script: $0
*** Copyright 2004, Gamma Remote Sensing, v1.3 17-Jan-2005 clw ***
*** extract range and azimuth offsets for a range window from an text offset file ***

usage: $0 <offset> <r_min> <r_max> <r_plot> <az_plot> 

    offset   (input) list of range and azimuth offsets generated by offset_pwr (text)
    rmin     minimum range pixel number to extract range and azimuth offsets
    rmax     minimum range pixel number to extract range and azimuth offsets
    r_plot   range offsets xmgrace plot file
    az_plot  azimuth offsets xmgrace plot file    
       
EOS

open(OFF, "<$ARGV[0]") or die "\nERROR $0: offset data in text format does not exist: $ARGV[0]\n\n";
print "offset data: $ARGV[0]\n"; 

$rmin = $ARGV[1];
$rmax = $ARGV[2];
print "minimum range pixel: $ARGV[1]\n";
print "maximum range pixel: $ARGV[2]\n";

open(RPLT,">$ARGV[3]") or die "\nERROR $0: cannot open range offset plot file: $ARGV[3]\n"; 
open(AZPLT,">$ARGV[4]") or die "\nERROR $0: cannot open azimuth offset plot file: $ARGV[4]\n"; 
print "\nrange offset plot file: $ARGV[3]\n";
print "azimuth offset plot file: $ARGV[4]\n";

LINE: while (<OFF>) {		#read lines of processing list file
  chomp $_;			#remove new line from record
  next LINE if /^$/;		#skip blank lines in processing list
  next LINE if /^#/;		
  @fields = split;
  if (@fields[0] >= $rmin && @fields[0] <= $rmax){
    printf RPLT "@fields[1] @fields[2] @fields[4]\n";
    printf AZPLT "@fields[1] @fields[3] @fields[4]\n";
  }
}

printf RPLT "@    title \"range offsets file: $ARGV[0]\"\n";
printf RPLT "@    subtitle \"range span min: $rmin   max: $rmax\"\n";
printf RPLT "@    s0 line type 0\n";
printf RPLT "@    s0 symbol 1\n";
printf RPLT "@    s0 symbol color 4\n";
printf RPLT "@    s0 symbol size 0.2\n";

printf AZPLT "@    title \"azimuth offsets file: $ARGV[0]\"\n";
printf AZPLT "@    subtitle \"range span min: $rmin   max: $rmax\"\n";
printf AZPLT "@    s0 line type 0\n";
printf AZPLT "@    s0 symbol 1\n";
printf AZPLT "@    s0 symbol color 4\n";
printf AZPLT "@    s0 symbol size 0.2\n";

close RPLT;
close AZPLT;
print "\nplotting offset data with xmgrace:\n\n";
print "xmgrace -noask -free -geometry 800x600 $ARGV[3]&\n";
print "xmgrace -noask -free -geometry 800x600 $ARGV[4]&\n";

system ("xmgrace -hdevice 'PNG' -noask -free -geometry 800x600 $ARGV[3]&"); 		 
system ("xmgrace -hdevice 'PNG' -noask -free -geometry 800x600 $ARGV[4]&"); 		 

exit 0;
